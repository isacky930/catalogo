<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Catálogo de Filmes - Firestore</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase SDK compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>Catálogo de Filmes</h1>

<form id="cadastro-filme">
    <h2>Adicionar Novo Filme</h2>
    <div>
        <label for="titulo">Título do Filme:</label>
        <input type="text" id="titulo" required>
    </div>
    <div>
        <label for="sinopse">Sinopse:</label>
        <textarea id="sinopse" required></textarea>
    </div>
    <button type="submit">Adicionar Filme</button>
</form>

<hr>

<h2>Minha Lista de Filmes</h2>
<div id="lista-filmes">
    <p>Nenhum filme cadastrado ainda.</p>
</div>

<script>
// =========================
// CONFIGURAÇÃO FIREBASE
// =========================
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO.firebaseapp.com",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET.appspot.com",
  messagingSenderId: "SEU_SENDER_ID",
  appId: "SEU_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const filmesCollection = db.collection("filmes");

// =========================
// CONFIGURAÇÃO OMDb
// =========================
const API_KEY = '37ad5a34';
const form = document.getElementById('cadastro-filme');
const listaFilmesContainer = document.getElementById('lista-filmes');

// =========================
// FUNÇÃO RENDERIZAR TODOS OS FILMES
// =========================
function renderizarTodosFilmes(filmes) {
  listaFilmesContainer.innerHTML = '';
  if(filmes.length === 0) {
    listaFilmesContainer.innerHTML = '<p>Nenhum filme cadastrado ainda.</p>';
    return;
  }

  filmes.forEach(doc => {
    const filme = doc.data();
    const id = doc.id;

    const filmeDiv = document.createElement('div');
    filmeDiv.classList.add('filme-item');

    const posterImg = document.createElement('img');
    posterImg.src = filme.poster && filme.poster !== "N/A"
      ? filme.poster
      : 'https://via.placeholder.com/110x160?text=Sem+Imagem';
    posterImg.alt = filme.titulo;
    posterImg.classList.add('filme-poster');

    const infoDiv = document.createElement('div');
    infoDiv.classList.add('filme-info');

    const tituloH3 = document.createElement('h3');
    tituloH3.textContent = filme.titulo;

    const sinopseP = document.createElement('p');
    sinopseP.textContent = filme.sinopse;

    const removerBotao = document.createElement('button');
    removerBotao.textContent = 'Remover';
    removerBotao.classList.add('btn-remover');
    removerBotao.addEventListener('click', () => {
      filmesCollection.doc(id).delete();
    });

    infoDiv.append(tituloH3, sinopseP, removerBotao);
    filmeDiv.append(posterImg, infoDiv);
    listaFilmesContainer.appendChild(filmeDiv);
  });
}

// =========================
// LISTENER FIRESTORE (REAL-TIME)
// =========================
filmesCollection.orderBy('titulo').onSnapshot(snapshot => {
  renderizarTodosFilmes(snapshot.docs);
});

// =========================
// ADICIONAR FILME
// =========================
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const titulo = document.getElementById('titulo').value.trim();
  const sinopse = document.getElementById('sinopse').value.trim();
  if(!titulo || !sinopse) {
    alert("Digite título e sinopse!");
    return;
  }

  let poster = '';
  try {
    const res = await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&t=${encodeURIComponent(titulo)}`);
    const data = await res.json();
    if(data.Response === "True" && data.Poster && data.Poster !== "N/A") poster = data.Poster;
  } catch(err) {
    console.warn("Erro OMDb, será usado placeholder.");
  }

  filmesCollection.add({titulo, sinopse, poster});
  form.reset();
});
</script>

</body>
</html>
